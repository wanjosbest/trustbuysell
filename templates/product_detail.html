{% extends "base.html" %}
{% load static %}

{% block header %}
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{ product.name }} - Product Details</title>
<link rel="stylesheet" href="{% static 'css/products.css' %}">
{% include "header.html" %}
{% endblock %}

{% block content %}
<main>
  {% for message in messages %}
  <div class="alert">{{ message }}</div>
  {% endfor %}

  <!-- Product Gallery -->
  <section class="gallery">
    {% if product.images.all %}
      {% with product.images.first as main_image %}
        <img id="mainImage" src="{{ main_image.image.url }}" alt="{{ product.name }}">
      {% endwith %}
    {% else %}
      <img id="mainImage" src="{% static 'img/no-image.png' %}" alt="No Image">
    {% endif %}
  </section>

  <div class="thumbs">
    {% for image in product.images.all %}
      <img src="{{ image.image.url }}" class="{% if forloop.first %}active{% endif %}" alt="{{ product.name }}">
    {% empty %}
      <p>No images available for this product.</p>
    {% endfor %}
  </div>

  <!-- Product Info -->
  <section class="info">
    <h1>{{ product.name }}</h1>
    <div class="seller">by <strong>{{ product.user.username }}</strong></div>
    <div class="price">â‚¦{{ product.discountedprice }}</div>

    <div class="actions">
      <a href="tel:{{ product.user.phone_number }}" class="btn btn-accent">ðŸ“ž Call Seller</a>
      <a href="{% url 'add-to-cart' product.id %}" class="btn btn-primary">Add to Cart</a>
    </div>
  </section>

  <!-- Description -->
  <section class="desc">
    <h2>Product Description</h2>
    <p>{{ product.description }}</p>
  </section>

  <!-- Related Products -->
  <section class="related">
    <h2>Related Products</h2>
    <div class="rel-grid">
      {% for related in related_product %}
      <div class="rel-card">
        {% if related.images.first %}
          <img src="{{ related.images.first.image.url }}" alt="{{ related.name }}">
        {% else %}
          <img src="{% static 'img/no-image.png' %}" alt="No Image">
        {% endif %}
        <div class="body">
          <div class="title">{{ related.name }}</div>
          <div class="price">â‚¦{{ related.discountedprice }}</div>
        </div>
      </div>
      {% endfor %}
    </div>
  </section>

  <!-- Reviews Section -->
  <section class="reviews-container">
    <h2 class="section-title">Customer Reviews ({{ reviews.count }})</h2>

    {% if reviews %}
    <div class="review-list">
      {% for review in reviews %}
      <div class="review-card">
        <div class="review-header">
          <span class="review-user">{{ review.user.username }}</span>
          <div class="stars">
            {% for i in "12345" %}
            <span class="star {% if forloop.counter <= review.rating %}filled{% endif %}">â˜…</span>
            {% endfor %}
          </div>
        </div>
        <p class="review-message">{{ review.message }}</p>
        <div class="review-date">{{ review.created_at|date:"M d, Y - h:i A" }}</div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p>No reviews yet. Be the first to review this product!</p>
    {% endif %}

    <hr class="divider">

    {% if user.is_authenticated %}
    <form method="POST" class="review-form">
      {% csrf_token %}
      <textarea name="message" placeholder="Share your experience..." required></textarea>
      <label>Rating:</label>
      <div class="stars">
        {% for i in "12345" %}
        <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}" style="display:none;">
        <span class="star" data-value="{{ i }}">â˜…</span>
        {% endfor %}
      </div>
      <button type="submit" class="submit-btn">Submit Review</button>
    </form>
    {% else %}
    <p class="login-msg"><a href="{% url 'login' %}">Login</a> to write a review.</p>
    {% endif %}
  </section>
</main>

<!-- JavaScript -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const thumbs = document.querySelectorAll('.thumbs img');
  const mainImage = document.getElementById('mainImage');

  thumbs.forEach(t => {
    t.addEventListener('click', () => {
      thumbs.forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      mainImage.src = t.src;
    });
  });

  const stars = document.querySelectorAll(".review-form .star");
  if (stars.length) {
    const ratingInput = document.createElement("input");
    ratingInput.type = "hidden";
    ratingInput.name = "rating";
    document.querySelector(".review-form").appendChild(ratingInput);

    stars.forEach((star, index) => {
      star.addEventListener("click", () => {
        const value = index + 1;
        ratingInput.value = value;
        stars.forEach((s, i) => s.classList.toggle("selected", i < value));
      });
      star.addEventListener("mouseenter", () => {
        stars.forEach((s, i) => s.classList.toggle("filled", i <= index));
      });
      star.addEventListener("mouseleave", () => {
        stars.forEach((s, i) => s.classList.toggle("filled", i < ratingInput.value));
      });
    });
  }
});
</script>
{% endblock %}
